name: "CodeQL"

on:
  workflow_call:
    inputs:
      publish:
        type: boolean
        description: "Publish SARIF"
        default: true

  workflow_dispatch: {}
  push:
    branches: ["master"]
  schedule:
    - cron: "0 0 * * 1"

permissions:
  contents: read

jobs:
  analyze:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ["java"]
        # CodeQL supports [ $supported-codeql-languages ]
        # Learn more about CodeQL language support at https://aka.ms/codeql-docs/language-support

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2.7.0
        with:
          disable-sudo: true
          egress-policy: block
          allowed-endpoints: >
            api.azul.com:443
            api.github.com:443
            cdn.azul.com:443
            dl.google.com:443
            docs.oracle.com:443
            errorprone.info:443
            github.com:443
            objects.githubusercontent.com:443
            oss.sonatype.org:443
            repo.maven.apache.org:443
            services.gradle.org:443
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false
      - name: 'Set up JDK 21'
        uses: actions/setup-java@9704b39bf258b59bc04b50fa2dd55e9ed76b47a8 # v4.1.0
        with:
          java-version: 21
          distribution: 'zulu'
          cache: 'maven'
      - name: Initialize CodeQL
        uses: github/codeql-action/init@8a470fddafa5cbb6266ee11b37ef4d8aae19c571 # v3.24.6
        continue-on-error: true
        with:
          languages: ${{ matrix.language }}
      - name: Build Package
        run: |
          ./mvnw \
            --strict-checksums \
            -B \
            -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn \
            install \
            -U \
            -DskipTests=true \
            -Dmaven.javadoc.skip=true \
            -Dgpg.skip \
            -f pom.xml
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@8a470fddafa5cbb6266ee11b37ef4d8aae19c571 # v3.24.6
        continue-on-error: true
        with:
          category: "/language:${{matrix.language}}"
